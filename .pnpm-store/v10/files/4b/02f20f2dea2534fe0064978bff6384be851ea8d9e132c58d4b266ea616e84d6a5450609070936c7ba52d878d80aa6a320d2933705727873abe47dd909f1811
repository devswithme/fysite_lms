{"version":3,"sources":["../src/updateJobs.ts"],"sourcesContent":["import type { UpdateJobs, Where } from 'payload'\n\nimport toSnakeCase from 'to-snake-case'\n\nimport type { DrizzleAdapter } from './types.js'\n\nimport { findMany } from './find/findMany.js'\nimport { upsertRow } from './upsertRow/index.js'\nimport { getTransaction } from './utilities/getTransaction.js'\n\nexport const updateJobs: UpdateJobs = async function updateMany(\n  this: DrizzleAdapter,\n  { id, data, limit: limitArg, req, returning, sort: sortArg, where: whereArg },\n) {\n  if (!(data?.log as object[])?.length) {\n    delete data.log\n  }\n  const whereToUse: Where = id ? { id: { equals: id } } : whereArg\n  const limit = id ? 1 : limitArg\n\n  const db = await getTransaction(this, req)\n  const collection = this.payload.collections['payload-jobs'].config\n  const tableName = this.tableNameMap.get(toSnakeCase(collection.slug))\n  const sort = sortArg !== undefined && sortArg !== null ? sortArg : collection.defaultSort\n\n  const jobs = await findMany({\n    adapter: this,\n    collectionSlug: 'payload-jobs',\n    fields: collection.flattenedFields,\n    limit: id ? 1 : limit,\n    pagination: false,\n    req,\n    sort,\n    tableName,\n    where: whereToUse,\n  })\n  if (!jobs.docs.length) {\n    return []\n  }\n\n  const results = []\n\n  // TODO: We need to batch this to reduce the amount of db calls. This can get very slow if we are updating a lot of rows.\n  for (const job of jobs.docs) {\n    const updateData = {\n      ...job,\n      ...data,\n    }\n\n    const result = await upsertRow({\n      id: job.id,\n      adapter: this,\n      data: updateData,\n      db,\n      fields: collection.flattenedFields,\n      ignoreResult: returning === false,\n      operation: 'update',\n      req,\n      tableName,\n    })\n\n    results.push(result)\n  }\n\n  if (returning === false) {\n    return null\n  }\n\n  return results\n}\n"],"names":["toSnakeCase","findMany","upsertRow","getTransaction","updateJobs","updateMany","id","data","limit","limitArg","req","returning","sort","sortArg","where","whereArg","log","length","whereToUse","equals","db","collection","payload","collections","config","tableName","tableNameMap","get","slug","undefined","defaultSort","jobs","adapter","collectionSlug","fields","flattenedFields","pagination","docs","results","job","updateData","result","ignoreResult","operation","push"],"mappings":"AAEA,OAAOA,iBAAiB,gBAAe;AAIvC,SAASC,QAAQ,QAAQ,qBAAoB;AAC7C,SAASC,SAAS,QAAQ,uBAAsB;AAChD,SAASC,cAAc,QAAQ,gCAA+B;AAE9D,OAAO,MAAMC,aAAyB,eAAeC,WAEnD,EAAEC,EAAE,EAAEC,IAAI,EAAEC,OAAOC,QAAQ,EAAEC,GAAG,EAAEC,SAAS,EAAEC,MAAMC,OAAO,EAAEC,OAAOC,QAAQ,EAAE;IAE7E,IAAI,CAAER,MAAMS,KAAkBC,QAAQ;QACpC,OAAOV,KAAKS,GAAG;IACjB;IACA,MAAME,aAAoBZ,KAAK;QAAEA,IAAI;YAAEa,QAAQb;QAAG;IAAE,IAAIS;IACxD,MAAMP,QAAQF,KAAK,IAAIG;IAEvB,MAAMW,KAAK,MAAMjB,eAAe,IAAI,EAAEO;IACtC,MAAMW,aAAa,IAAI,CAACC,OAAO,CAACC,WAAW,CAAC,eAAe,CAACC,MAAM;IAClE,MAAMC,YAAY,IAAI,CAACC,YAAY,CAACC,GAAG,CAAC3B,YAAYqB,WAAWO,IAAI;IACnE,MAAMhB,OAAOC,YAAYgB,aAAahB,YAAY,OAAOA,UAAUQ,WAAWS,WAAW;IAEzF,MAAMC,OAAO,MAAM9B,SAAS;QAC1B+B,SAAS,IAAI;QACbC,gBAAgB;QAChBC,QAAQb,WAAWc,eAAe;QAClC3B,OAAOF,KAAK,IAAIE;QAChB4B,YAAY;QACZ1B;QACAE;QACAa;QACAX,OAAOI;IACT;IACA,IAAI,CAACa,KAAKM,IAAI,CAACpB,MAAM,EAAE;QACrB,OAAO,EAAE;IACX;IAEA,MAAMqB,UAAU,EAAE;IAElB,yHAAyH;IACzH,KAAK,MAAMC,OAAOR,KAAKM,IAAI,CAAE;QAC3B,MAAMG,aAAa;YACjB,GAAGD,GAAG;YACN,GAAGhC,IAAI;QACT;QAEA,MAAMkC,SAAS,MAAMvC,UAAU;YAC7BI,IAAIiC,IAAIjC,EAAE;YACV0B,SAAS,IAAI;YACbzB,MAAMiC;YACNpB;YACAc,QAAQb,WAAWc,eAAe;YAClCO,cAAc/B,cAAc;YAC5BgC,WAAW;YACXjC;YACAe;QACF;QAEAa,QAAQM,IAAI,CAACH;IACf;IAEA,IAAI9B,cAAc,OAAO;QACvB,OAAO;IACT;IAEA,OAAO2B;AACT,EAAC"}